start_qemu()
{
    VM_NAME="$1"

    set_qemu_program $QEMU_CPU

    debug "Starting qemu $1"
    debug " $VM_START_ARGS"
    MONITOR_ARGS="-monitor unix:/tmp/qemu-$VM_NAME.sock,server,nowait "
    REDIR_ARGS="-redir tcp:$SSH_PORT::22 "
    EXTRA_ARGS="-no-reboot -nographic -display none "

    START_VM="$QEMU_BINARY -kernel $QEMU_KERNEL"

    if [ "$QEMU_CPU" != "" ]
    then 
	START_VM="$START_VM -cpu $QEMU_CPU  "
    fi  	 

    START_VM="$START_VM -m 256 -M versatilepb "
    START_VM="$START_VM -no-reboot "
    if [ "$QEMU_ROOT" != "" ]
    then
	START_VM="$START_VM -append \"root=${QEMU_ROOT} panic=1 rootfstype=ext4 rw \" "
    else
	START_VM="$START_VM -append \"root=/dev/sda1\" "
    fi

    START_VM="$START_VM -nographic -hda $QEMU_HDA"	

    if [ "$QEMU_INITRD" != "" ]
    then
	START_VM="$START_VM -initrd $QEMU_INITRD"
    fi
    START_VM="$START_VM  $MONITOR_ARGS $REDIR_ARGS $EXTRA_ARGS"

    if [ ! -f $QEMU_KERNEL ] || [ ! -f $QEMU_INITRD ] || [ ! -f $QEMU_HDA ]
        then
        debug "Can't find either of:"
        debug "  kernel: $QEMU_KERNEL"
        debug "  initrd: $QEMU_INITRD"
        debug "  hda: $QEMU_HDA"
        return 1
    fi

    if [ "$VNC_PORT" != "" ]
    then
        START_VM="$START_VM -vnc :$VNC_PORT"
    fi
    debug " $START_VM"        
    echo "$START_VM" | bash &
   
    return 0
# /dev/null
}

set_qemu_program()
{
    WANTED_CPU=$1
    export QEMU_BINARY
    case $WANTED_CPU in
        "arm")
         QEMU_BINARY=qemu-system-arm
         ;;
        "arm1176")
         QEMU_BINARY=qemu-system-arm
         ;;
        "armel")
         QEMU_BINARY=qemu-system-arm
         ;;
        *)
         echo "Unsupported cpu $WANTED_CPU"
         ;;
    esac
}

check_qemu_proc()
{
    PROC_EXPR=$1

    RET=$(ps ax -U autobuilder -u autobuilder  | grep qemu | grep -v grep | grep -w $PROC_EXPR | wc -l)

    debug "Number of qemu processes: $RET"
    
    return $RET
}

kill_qemu_sub() 
{
    QEMU_NAME=$1
    SIG=$2

    QEMU_VM_PROC=$(ps x -U autobuilder -u autobuilder  | grep qemu | grep -v grep | grep -w $VB_NAME | awk '{print $1}')
    if [ "$QEMU_VM_PROC" != "" ]
    then
	kill $SIG $QEMU_VM_PROC
	sleep 3
    else
	return
    fi

}


kill_qemu() 
{
    QEMU_NAME=$1

    kill_qemu_sub $QEMU_NAME 
    kill_qemu_sub $QEMU_NAME SIGINT
    kill_qemu_sub $QEMU_NAME SIGKILL
}

stop_qemu()
{
    VB_NAME=$1
    debug "Stopping qemu $VM_NAME"

    echo "stop_qemu $1"
    if [ "$VB_NAME" != "" ]
    then

	DELAY=1

    echo "1 checking _qemu $1"

	check_qemu_proc $VB_NAME
	RET=$?
    echo "1 checking _qemu $1 => $RET"
	
	if [ $RET -eq 0 ];
	then
	    return
	fi

	echo "2 stop  $VB_NAME $RET"

        debug "Send to QEMU $VB_NAME: ctrl-alt-delete"
        send_to_qemu $VB_NAME "sendkey ctrl-alt-delete"
        wait_for_state down $DELAY $VB_NAME


        is_qemu_up $VB_NAME
        RET=$?
	echo "3 qemu up?  $VB_NAME $RET"
        if [ "$RET" != "0" ]
        then
            echo " client is down, returning"
            debug " client is down, returning"
            return
        fi

	check_qemu_proc $VB_NAME
	if [ $? -eq 0 ];
	then
	    echo " no proc found"
	    return
	fi

        debug "Send to QEMU $VB_NAME: system_powerdown"
        send_to_qemu $VB_NAME "system_powerdown"
        wait_for_state down $DELAY $VB_NAME


        is_qemu_up $VB_NAME
        RET=$?
	echo "4 is up?  $VB_NAME $RET"

        if [ "$RET" != "0" ]
        then
            debug " client is down, returning"
            return
        fi

	echo "check 5.."
	check_qemu_proc $VB_NAME
	if [ $? -eq 0 ];
	then
	    return
	fi

	echo " send quit.."
        debug "Send to QEMU $VB_NAME: quit"
        send_to_qemu $VB_NAME "quit"
        wait_for_state down $DELAY $VB_NAME

	echo " check again ().."

	check_qemu_proc $VB_NAME
	if [ $? -eq 0 ];
	then
	    echo "no qemu procs...."
	    return
	fi

	echo "5 killing"
	kill_qemu

    fi



}

is_qemu_up()
{
    export WANTED_VM=$1

    CNT=$(send_to_qemu $WANTED_VM "info status" | grep "VM status: running" | wc -l)

    debug " is_qemu_up: $CNT"
#    echo " is_qemu_up: $CNT"

    # If the VM is running (>1), return 0
    if [ $CNT -ne 0 ]
    then
        debug "qemu vm \"$WANTED_VM\" is running."
        return 0
    fi

    debug "qemu vm \"$WANTED_VM\" is NOT running."
    return 1
}

send_to_qemu()
{
    WANTED_VM=$1
    MSG=$2

#    echo "MSG: $MSG"
    SOCKET=/tmp/qemu-${WANTED_VM}.sock

    echo "$MSG" | socat - unix-connect:${SOCKET} 2>/dev/null | \
        grep -v "(qemu)" | grep -v "QEMU [0-9\. ]*monitor"
}

android-specific()
{
    echo "Listing running qemu devices not possible at the moment"
}


list_running_qemu() 
{
    echo "  Qemu"

    QEMUS=$(ps x -U autobuilder -u autobuilder  | grep qemu | grep -v grep | grep sock | sed 's, ,\n,g' | grep sock )
    if [ "$QEMUS" != ""  ] 
    then
	for token in  $QEMUS
	do
	    token=${token#unix:/tmp/qemu-}
	    QEMU_NAME=${token%%.sock,server,nowait}
	    IFS=" "
	    echo "   |--$QEMU_NAME"  
	    
	    SUB_CLIENTS=$(find $ETC_DIRS -name "*.conf" 2>/dev/null | grep "clients/" | xargs grep -l $QEMU_NAME)
	    
#	echo "SUB_CLIENTS: $SUB_CLIENTS"
	    if [ "$SUB_CLIENTS" != "" ]
	    then
		for qe in $SUB_CLIENTS
		do
#		echo " ---- $AD_NAME"
		    QE_SHORT_NAME=$(basename $qe)
		    echo "     |--$QE_SHORT_NAME  (client)"  
		    FOUND=true
		done
#	    if [ "$FOUND" = "false" ]
#	    then
#		echo "      not in use"
#	    fi
	    else
		echo "     |--$QEMU_NAME  (no clients using it)"  
	    fi
	done
    else
	echo "    * No Qemu clients currently running"
    fi
    
}
