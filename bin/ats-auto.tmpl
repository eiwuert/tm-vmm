#!/bin/bash

ATS_DIR=__ATS_DIR__
ATS_CLIENT=$ATS_DIR/bin/ats-client
ATS_AUTO_NAME=$(basename $0)

SCRIPT_DIR=$ATS_DIR/share/ats/scripts

usage()
{
    echo "Syntax error"
    echo "  $ATS_AUTO_NAME <client> <external-script>"
}

#
# Read in functions file
#
ATS_FUNCTION=$SCRIPT_DIR/functions
if [ ! -f  $ATS_FUNCTION ]
then
    echo "$ATS_NAME: Could not find functions file ($ATS_FUNCTION)"
    # exit 6 - means we couldn't find the functions file
    exit 6
fi
. $ATS_FUNCTION

SCRIPT_IDX=0

while [ "$1" != "" ]
do
    case "$1" in
	"--client")
	    CLIENT_NAME=$2
	    shift
	    ;;
	
	"--remote-script")
	    shift
	    SCRIPTS_TO_EXECUTE[$SCRIPT_IDX]="rem-user:$1"
	    SCRIPT_IDX=$(( $SCRIPT_IDX + 1 ))
	    ;;
	
	"--remote-script-root")
	    shift
	    SCRIPTS_TO_EXECUTE[$SCRIPT_IDX]="rem-root:$1"
	    SCRIPT_IDX=$(( $SCRIPT_IDX + 1 ))
	    ;;
	
	"--local-script")
	    shift
	    SCRIPTS_TO_EXECUTE[$SCRIPT_IDX]="loc-user:$1"
	    SCRIPT_IDX=$(( $SCRIPT_IDX + 1 ))
	    
	    ;;
	
	*)
	    echo "SYNTAX ERROR \"$1\""
	    ;;
	
    esac
    shift
done

if [ $SCRIPT_IDX -eq 0 ]
then
    echo "You supply at least one script to execute. Either"
    echo "   --remote-script your-script.sh"
    echo "   --local-script your-script.sh"
    exit 1
fi

if [ "$CLIENT_NAME" = "" ]
then
	echo "Missing client name"
	echo "   --client YOUR-CLIENT"
	exit 1
fi



#######################################
#
# Start up client
#
#######################################
start_client_wait_for_ssh $CLIENT_NAME 
exit_on_error "$RET" "Start up client"


#######################################
#
# Execute user supplied scripts
#
#######################################
exec_user_scripts
exit_on_error "$RET" "Executing user supplied scripts ($script)"


#######################################
#
# Stop client
#
#######################################
auto_debug "Stopping client $CLIENT_NAME"
$ATS_CLIENT --stop-client $CLIENT_NAME
auto_debug "  stopping client returned: $?"

exit $RET
